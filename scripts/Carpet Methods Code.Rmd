---
title: "Carpet Methods Code"
author: Lauren Sullivan and Lauren Shoemaker
output: 
  html_document:
  smart: no
theme: flatly
float: yes
css: "style.css"    
editor_options: 
  chunk_output_type: console
mainfont: Arial
mathfont: Arial
fontsize: 12pt
subtitle:
---

# {.tabset .tabset-pills .tabset-fade}
  
## Prolog


```{r, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE}

# PROLOG   ##############################################################################

# PROJECT: Seed Rain Methods
# PURPOSE: Data cleaning 
#
# AUTHORS: Lauren Sullivan (llsull@msu.edu) & Lauren Shoemaker (lshoema1@uwyo.edu)
# COLLAB:  Melissa DeSiervo, Larissa Kahan
# EDITED:  1 February 2025
#
# FILES:   1) data/L0/MO_seedrain_raw.csv
#          2) data/LO/MO_seedweight_raw.csv
#          3) data/L0/CO_seedrain_raw.csv
#          4) data/L0/CO_seedweight_raw.csv
#
# NOTES:   creates "strict" datasets where we just focus on the species of interest 
#             not herbivory or other species that were collected in the traps
#
# NEXT STEPS: 


# PROLOG   ##############################################################################
```
```{r, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
# clear workspace
rm(list=ls())

# working directory
# set working directory to "source file location"

# libraries
library(tidyverse)
library(RColorBrewer)
library(cowplot)
library(glmmTMB)


# data
mo <- read_csv("../data/L0/MO_seedrain_raw.csv")
mo_mass <- read_csv("../data/L0/MO_seedweight_raw.csv")

co <- read_csv("../data/L0/CO_seedrain_raw.csv")
co_mass <- read_csv("../data/L0/CO_seedweight_raw.csv")

```
## Data Cleaning

Clean and combine all data from CO and MO sites - both the recovery and the seed mass data.

Missouri data cleaning

```{r, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}

# clean up treatment names and times

mo$time_month[mo$time_month == '1 month'] <- 1
mo$time_month[mo$time_month == '2 month'] <- 2
mo$time_month[mo$time_month == '1 week'] <- 0.25

mo$time_month <- as.numeric(mo$time_month)


# clean recovery data to just be the species we selected, not the extra 
#      seeds we caught throughout the experiment

mo_slim <- mo %>%
  filter(species == "LESCAP" | species == "DESCAN" | species == "TRIPER" |
         species == "SCHSCO" | species == "ECHANG" | species == "SPOHET" |
         species == "RUDHIR" | species == "CORTIN")


# clean seed mass data

mo_mass_small <- mo_mass %>% 
  group_by(species) %>%
  dplyr::summarize(mean_1seed = mean(lot_mass_g)/25)

# rename species to match recovery data
mo_mass_small$species[mo_mass_small$species == 'RATPIN'] <- "RUDHIR"

```

Colorado data cleaning

```{r, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}

# clean up treatment names and times

co$treatment[co$treatment == 's'] <- "sticky"
co$treatment[co$treatment == 'c'] <- "carpet"


# clean recovery data to just be the species we selected, not the extra 
#      seeds we caught throughout the experiment

co_slim <- co %>%
  filter(species != ("various"))

co_mass_small <- co_mass %>%
  pivot_longer(
    cols = afrut:yglau,
    names_to = "species",
    values_to = "mass"
  ) %>%
  group_by(species) %>%
  dplyr::summarize(mean_1seed = mean(mass)/25)


#rename species to match recovery data
co_mass_small$species[co_mass_small$species == 'afrut'] <- "a.fruticosa"
co_mass_small$species[co_mass_small$species == 'bdact'] <- "b.dactyloides"
co_mass_small$species[co_mass_small$species == 'bgrac'] <- "b.gracilis"
co_mass_small$species[co_mass_small$species == 'dpurp'] <- "d.purpurea"
co_mass_small$species[co_mass_small$species == 'hannu'] <- "h.annuus"
co_mass_small$species[co_mass_small$species == 'origi'] <- "s.rigida"
co_mass_small$species[co_mass_small$species == 'sangu'] <- "s.angustifolium"
co_mass_small$species[co_mass_small$species == 'yglau'] <- "y.glauca"

```

Join data together


```{r, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
### Create full dataset with both sites

dat_all <- full_join(mo_slim, co_slim)


# create a %consumed column

dat_all$pct_recovered <- dat_all$number_recovered/dat_all$number_original
dat_all$time_month <- as.factor(dat_all$time_month)


```

## Exploratory Figures

Exploratory figures of recovery rates by collection type and by site.

First lets look at the percent recovered.

```{r, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}


mo_raw <- dat_all %>%
  filter(site == "mo" & treatment != "post-sticky") %>%
ggplot( aes(x = time_month, y = pct_recovered, color = treatment))+
  geom_boxplot()+
  facet_grid(cols = vars(species))+
  scale_color_brewer(palette = "Set1")+
  theme_bw()

co_raw <- dat_all %>%
  filter(site == "co") %>%
  ggplot(aes(x = time_month, y = pct_recovered, color = treatment))+
  geom_boxplot()+
  facet_grid(cols = vars(species))+
  scale_color_brewer(palette = "Set1")+
  theme_bw()

plot_grid(mo_raw, co_raw, ncol = 1, labels = c("A)", "B)"))

## save figure

# note: will clean this up as we go forward but not important for now.
pdf("../figures/all_raw_data.pdf", width = 10, height = 8)

plot_grid(mo_raw, co_raw, ncol = 1, labels = c("A)", "B)"))

invisible(dev.off())

```

Next let's look at the LRR of recovery of carpets relative to sticky traps, so positive values mean the sticky traps retain more, and the negative values mean the carpets retain more.



```{r, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}

# ok make relativized plot with carpet compared to sticky.


dat_small <- dat_all[,1:8]
dat_small <- subset(dat_small, treatment != "post-sticky")

dat_wide <- dat_small %>%
  pivot_wider(
    names_from = treatment,
    values_from = number_recovered
  )

dat_wide$LRR_removed <- log(dat_wide$sticky / dat_wide$carpet)


mo_rel <- ggplot(subset(dat_wide, site == "mo"), aes(x = time_month, y = LRR_removed))+
  geom_boxplot()+
  #geom_point(position = position_jitter(width = 0.2))+
  geom_hline(yintercept = 0, linetype = "dashed", color = "red")+
  facet_grid(cols = vars(species))+
  scale_color_brewer(palette = "Set1")+
  theme_bw()

co_rel <- ggplot(subset(dat_wide, site == "co"), aes(x = time_month, y = LRR_removed))+
  #geom_point(position = position_jitter(width = 0.2))+
  geom_boxplot()+
  geom_hline(yintercept = 0, linetype = "dashed", color = "red")+
  facet_grid(cols = vars(species))+
  scale_color_brewer(palette = "Set1")+
  theme_bw()

plot_grid(mo_rel, co_rel, ncol = 1, labels = c("A)", "B)"))


## save figure

# note: will clean this up as we go forward but not important for now.
pdf("../figures/all_relative_data.pdf", width = 10, height = 8)

plot_grid(mo_rel, co_rel, ncol = 1, labels = c("A)", "B)"))

invisible(dev.off())

```

## Analysis

Explore how seed removal is a function of seed size, trap method and time with a random effect for block nested within site.


NOTE: as we go forward for now time is 1,2,3 because I turned the factor back into a number.  So they're ordered but the time is different between them.  Will need to think if this is a problem or not.

NOTE2: Still working through which are the best models because there is a lot of interesting stuff here....

```{r, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}

# add seed mass data into big dataset.
mass_all <- rbind(mo_mass_small, co_mass_small)
dat_full <- left_join(dat_all, mass_all)

# make month numeric
dat_full$time_month <- as.numeric(dat_full$time_month)

# remove the post-sticky treatment from MO
dat_full <- subset(dat_full, treatment != "post-sticky")


# Mod1
mod1 <- glmmTMB(pct_recovered ~ treatment * mean_1seed + time_month + (1|site/block), 
                data = dat_full, 
                weights = number_original, 
                family = binomial)
summary(mod1)


dat_full$number_lost <- dat_full$number_original - dat_full$number_recovered

#percent recovered vs seed mass across sites
#getting weird warning message.
ggplot(dat_full, aes(x = mean_1seed, y = number_recovered/(number_recovered+number_lost), 
                     color = treatment, success=number_recovered, fail=number_lost))+
  geom_point()+
  theme_bw()+
  geom_smooth(method="glm",
              method.args=list(family="binomial"),
              formula = cbind(success, fail) ~ x)

#percent recovered vs seed mass with sites as panels
#getting weird warning message.
ggplot(dat_full, aes(x = mean_1seed, y = number_recovered/(number_recovered+number_lost), 
                     color = treatment, success=number_recovered, fail=number_lost))+
  geom_point()+
  theme_bw()+
  geom_smooth(method="glm",
              method.args=list(family="binomial"),
              formula = cbind(success, fail) ~ x)+
   facet_wrap(~site, scale = "free_x")






```
